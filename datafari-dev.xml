<?xml version="1.0" encoding="UTF-8" ?>

<!-- NOTE: This Ant task is intended to be used for partial Datafari rebuild on dev environment only, while dev on-going.
It only rebuilds the Java classes of Datafari web application and copies the web resources to the standard output folder 
of Maven full build. -->

<!-- Pre-requisite: having run once Maven on pom.xml of datafari root -->

<project name="datafari-deploy" default="all" basedir=".">

	<property name="datafari.context.app" value="Datafari" />
	<property name="tomcat.pw" value="admin" />

	<!-- If project.dir not set, set it as basedir (datafari directory) -->
	<condition property="project.dir" else="${basedir}">
		<isset property="project.dir" />
	</condition>

	<!-- Source directories -->
	<property name="dist.src.dir" value="${project.dir}/dist" />
	<property name="tests.dir" value="${project.dir}/tests" />

	<target name="all" depends="clean-datafari,configure,build,tests,deploy" />

	<target name="redeploy" depends="clean-datafari,build,tests,deploy" />

	<target name="clean-datafari">
		<delete dir="tomcat/webapps/${datafari.context.app}" />
	</target>

	<target name="configure">
		<replace file="tomcat/conf/tomcat-users.xml" token="@PASSWORD@" value="${tomcat.pw}" />
	</target>

	<target name="deploy">
		<!-- Copy all the content of dist directory (newly built classes plus dependencies) to the webapps directory of Tomcat -->
		<copy toDir="tomcat/webapps/${datafari.context.app}" overwrite="true" force="true">
			<fileset dir="${dist.src.dir}" />
		</copy>
	</target>
	
	<path id="src.path">
	  <pathelement location="${project.dir}/src/main/java" />
	  <pathelement location="${project.dir}/src/test/java" />
	</path>

	<target name="build">

		<!-- Copy Web resources (HTML, JSP, CSS, etc) -->
		<copy toDir="${dist.src.dir}" overwrite="true" force="true">
			<fileset dir="${project.dir}/WebContent" />
		</copy>

		<javac destdir="${dist.src.dir}/WEB-INF/classes" includeantruntime="false" debug="on" debuglevel="lines,vars,source" verbose="off" source="1.8" target="1.8">
			<classpath>
				<!-- Reference Maven dependencies for Java compilation -->
				<!-- Artifacts for Java classes copied to dist directory by task copy-dependencies of datafari-core POM -->
				<fileset dir="${dist.src.dir}/WEB-INF/lib" />
			</classpath>

			<src refid="src.path" />

			<!-- These sources will be compiled as separate modules by Maven main POM, so we don't compile them here -->
			<exclude name="com/francelabs/realm/**" />
			<exclude name="com/francelabs/manifoldcf/**" />
			<exclude name="com/francelabs/datafari/updateprocessor/**" />
			<exclude name="com/francelabs/datafari/searchcomp/**" />
		</javac>

		<!-- Redeploy resources, if any -->
		
		<!-- No resources for the moment
		<copy toDir="${dist.src.dir}/WEB-INF/classes" overwrite="true" force="true">
			<fileset dir="${project.dir}/src/main/resources" />
		</copy>
		-->

	</target>
	
	<path id="test.path">
		<pathelement location="${dist.src.dir}/WEB-INF/classes"/>
		<fileset dir="${tests.dir}/lib">
			<include name="**/*.jar"/>
		</fileset>
	</path>
	
	<target name="tests">
		<junit fork="yes" printsummary="yes">
			<classpath refid="test.path" />
			<batchtest>
	            <fileset dir="${project.dir}/src/test/java" includes="**/*.java"/>
				<formatter type="plain" usefile="false"/>
	        </batchtest>
		</junit>
	</target>

</project>
