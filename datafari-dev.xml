<?xml version="1.0" encoding="UTF-8" ?>

<!-- NOTE: This Ant task is intended to be used for partial Datafari rebuild on dev environment only, while dev on-going.
It only rebuilds the Java classes of Datafari web application and copies the web resources to the standard output folder 
of Maven full build. -->

<!-- Pre-requisite: having run once Maven on pom.xml of datafari root -->
	
<project name="datafari-deploy" default="all" basedir="." xmlns:artifact="antlib:org.apache.maven.artifact.ant">

	<!-- Add a Ant taskdef to be able to reference Maven repo from Ant (needed as classpath for compilation) -->
	<path id="maven-ant-tasks.classpath" path="dev-tools/setup-devenv/bin/maven-ant-tasks-2.1.3.jar" />
	<typedef resource="org/apache/maven/artifact/ant/antlib.xml" uri="antlib:org.apache.maven.artifact.ant" classpathref="maven-ant-tasks.classpath" />

	<property name="datafari.context.app" value="Datafari" />
	<property name="tomcat.pw" value="admin" />

	<!-- If project.dir not set, set it as basedir (datafari directory) -->
	<condition property="project.dir" else="${basedir}">
		<isset property="project.dir" />
	</condition>

	<!-- Source directories -->
	<property name="dist.src.dir" value="${project.dir}/dist" />

	<target name="all" depends="clean-datafari,configure,build,deploy" />

	<target name="redeploy" depends="clean-datafari,build,deploy" />

	<target name="clean-datafari">
		<delete dir="tomcat/webapps/${datafari.context.app}" />
	</target>

	<target name="configure">
		<replace file="tomcat/conf/tomcat-users.xml" token="@PASSWORD@" value="${tomcat.pw}" />
	</target>

	<target name="deploy">
		<copy toDir="tomcat/webapps/${datafari.context.app}" overwrite="true" force="true">
			<fileset dir="${dist.src.dir}" />
		</copy>
	</target>

	<target name="build">

		<!-- Copy Web resources (HTML, JSP, CSS, etc) -->
		<copy toDir="${dist.src.dir}" overwrite="true" force="true">
			<fileset dir="${project.dir}/WebContent" />
		</copy>

		<!-- Reference Maven dependencies for Java compilation -->
		<!-- Needs to be run on a JDK (if you get strange errors check which runtime environment is being used by Ant)-->
		<artifact:dependencies filesetId="deps.fileset">
			<pom file="datafari-dependencies/pom.xml" />
		</artifact:dependencies>

		<javac destdir="${dist.src.dir}/WEB-INF/classes" debug="on" debuglevel="lines,vars,source" verbose="off" source="1.7" target="1.7">
			<classpath>
				<fileset refid="deps.fileset" />
			</classpath>

			<src path="${project.dir}/src/main/java" />

			<!-- These sources will be compiled as separate modules by Maven main POM, so we don't compile them here -->
			<exclude name="com/francelabs/realm/**" />
			<exclude name="com/francelabs/manifoldcf/**" />
			<exclude name="com/francelabs/datafari/updateprocessor/**" />
			<exclude name="com/francelabs/datafari/searchcomp/**" />
		</javac>

		<copy toDir="${dist.src.dir}/WEB-INF/classes" overwrite="true" force="true">
			<fileset dir="${project.dir}/src/main/resources" />
		</copy>

	</target>

</project>
