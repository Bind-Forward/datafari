<!DOCTYPE html>
<html>
<head>
<script src="./../plugins/jquery/jquery.min.js" type="text/javascript"></script>
<script src="./../plugins/jquery-ui/jquery-ui.min.js" type="text/javascript"></script>
<style src="./../css/style_v2.css" type="text/css"></style>
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body>
	<!--Start Breadcrumb-->
	<div class="row">
		<div id="breadcrumb" class="col-xs-12">
			<a href="#" class="show-sidebar"> <i class="fa fa-bars"></i>
			</a>
			<ol class="breadcrumb pull-left">
				<li><a id="topbar1" href="index.html"></a></li>
				<li><a id="topbar2" href="#"></a></li>
				<li><a id="topbar3" href="#"></a></li>
			</ol>
			<div id="social" class="pull-right">
				<a href="#"><i class="fa fa-google-plus"></i></a> <a href="#"><i
					class="fa fa-facebook"></i></a> <a href="#"><i
					class="fa fa-twitter"></i></a> <a href="#"><i
					class="fa fa-linkedin"></i></a> <a href="#"><i
					class="fa fa-youtube"></i></a>
			</div>
		</div>
	</div>
	<!--End Breadcrumb-->
	<div class="row">
		<div class="col-xs-8 col-sm-4">
			<div id="search">
				<input type="text" id="searchBar" style="background-color: #FFFFFF;" onchange="javascript : getTab()"/>
				 <i style="color : #000000; top : 10px;"class="text-center fa fa-search" onclick="javascript : getTab()"></i>
			</div>
		</div>
	</div>
	<div id="anotherSection">
		<fieldset>
			<legend id="contextMenu"></legend>
			<div id="ajaxResponse" class="form-group" role="form" style="margin-right: 15px;"></div>
		</fieldset>
	</div>
	<div id="addAlerts">
		<fieldset>
			<legend id="legendAdd"></legend>
			<div id="addAlertsForm"></div>
		</fieldset>
	</div>
</body>
<script>
var d;
var data;
$(document).ready(function() {
    addAlerts();
    getTab();
    document.getElementById("legendAdd").innerHTML = window.i18n.msgStore['createAlerts'];
    document.getElementById("searchBar").placeholder = window.i18n.msgStore['alertsSearch'];
    document.getElementById("contextMenu").innerHTML = window.i18n.msgStore['Results'];
    document.getElementById("topbar1").innerHTML = window.i18n.msgStore['home'];
    document.getElementById("topbar2").innerHTML = window.i18n.msgStore['searchUser'];
    document.getElementById("topbar3").innerHTML = window.i18n.msgStore['addAlerts'];
});
function getTab(){
	//Cleans the response area
    $("#ajaxResponse").empty();
    //get the keyword of the search field and serialize it
    var keyword = $("input#searchBar").val();
    dataString = "keyword=" + keyword;
    $.ajax({			//Ajax request to the doGet of the Alerts servlet
        type: "GET",
        url: "./../admin/Alerts",
        data: dataString,
        //if received a response from the server
        success: function( data, textStatus, jqXHR) {
        		if(data.alerts!=undefined){
        		//get the data in a global var so it can be used in edit() or remove() 
        		d=data;	
        		var numb = data.alerts.length;
        		var i = 0;
        		//Append the table to the response area
                 $("#ajaxResponse").append("<div class=\"col-xs-12\"><div class=\"box\"><div class=\"box-header\"><div class=\"box-name\"><i class=\"fa fa-table\"></i><span>"+window.i18n.msgStore['capsuleList']+"</span></div><div class=\"box-icons\"><a class=\"collapse-link\"><i class=\"fa fa-chevron-up\"></i></a><a class=\"expand-link\"><i class=\"fa fa-expand\"></i></a><a class=\"close-link\"><i class=\"fa fa-times\"></i></a></div><div class=\"no-move\"></div></div><div id=\"boxCon\" class=\"box-content no-padding\">");
            	 $("#boxCon").append("<table id=\"table\" class=\"table table-striped table-bordered table-hover table-heading no-border-bottom\">");
                 $("#table").append("<thead><tr><th>Id</th><th>"+window.i18n.msgStore['keyword']+"</th><th>"+window.i18n.msgStore['subject']+"</th><th>"+window.i18n.msgStore['core']+"</th><th>"+window.i18n.msgStore['frequency']+"</th><th></th></tr></thead><tbody>");
                 while (i<numb){	//While they are still alerts to print
                	 var key = data.alerts[i].keyword;
                	 var doc = data.alerts[i];
                	 //Print the alert with an href of the keyword towards edit()
					 $("#table").append("<tr id=\""+i+"\"><th>"+doc._id+"</th><th><a href=\"javascript: edit("+i+")\">"+key+"</a></th><th>"+doc.subject+"</th><th>"+doc.core+"</th><th>"+doc.frequency+"</th><th class=\"btn-danger text-center\"style=\"background-color : #d9534f; position : relative;\"><a href=\"javascript: remove("+i+")\" style=\"color: #FFFFFF; position: absolute;top: 50%;left: 50%; text-decoration: inherit; -ms-transform: translate(-50%,-50%); -webkit-transform: translate(-50%,-50%); transform: translate(-50%,-50%);\"><i class=\"fa fa-ban\" ></i></a></th></tr>");
					 //Print a button with an href towards remove()
					 i++;
                 }
				$("#table").append("</tbody></table>");
				$("#ajaxResponse").append("</div></div></div></div>");
        		}else{
        			$("#ajaxResponse").html("<div><b>"+window.i18n.msgStore['noAlerts']+"</b></div>");
        		}
        },
       
        //If there was no resonse from the server
        error: function(jqXHR, textStatus, errorThrown){
             console.log("Something really bad happened " + textStatus);
              $("#ajaxResponse").html(jqXHR.responseText);
        }
    });      
}
function addAlerts(){
	//Clean the response area
	$("#addAlertsForm").empty();
	//Print the add form in the response area
	$("#addAlertsForm").append("<div class=\"col-xs-12\"><div class=\"box\"><div class=\"box-header\"><div class=\"box-name\"><i class=\"fa fa-table\"></i><span>"+window.i18n.msgStore['createAlerts']+"</span></div><div class=\"box-icons\"><a class=\"collapse-link\"><i class=\"fa fa-chevron-up\"></i></a><a class=\"expand-link\"><i class=\"fa fa-expand\"></i></a></i></a></div><div class=\"no-move\"></div></div><div id=\"addBox\" class=\"box-content no-padding\">");
	$("#addBox").append("<form id=\"add\" class=\"form-horizontal\" role=\"form\">");
	$("#add").append("<fieldset id=\"fieldsAdd\" >");
	$("#fieldsAdd").append("<div class=\"form-group\" id=\"div1\">");
	$("#div1").append("<label class=\"col-sm-2 control-label\">"+window.i18n.msgStore['keyword']+"</label>");
	$("#div1").append("<input required type=\"text\" id=\"keyword\" name=\"keyword\" placeholder="+window.i18n.msgStore['keyword']+" class=col-sm-4 ></br>");
	$("#fieldsAdd").append("</div>");
	$("#fieldsAdd").append("<div class=\"form-group\" id=\"div11\">");
	$("#div11").append("<label class=\"col-sm-2 control-label\">"+window.i18n.msgStore['subject']+"</label>");
	$("#div11").append("<input required type=\"text\" id=\"subject\" name=\"subject\" placeholder="+window.i18n.msgStore['subject']+" class=col-sm-4 >");
	$("#fieldsAdd").append("</div>");
	$("#fieldsAdd").append("<div class=\"form-group\" id=\"div2\">");
	$("#div2").append("<label class=\"col-sm-2 control-label\">"+window.i18n.msgStore['core']+"</label>");
	$("#div2").append("<input required type=\"text\" id=\"core\" name=\"core\" placeholder=\"Core\" value=\"FileShare\" class=\"col-sm-4\"/>");
	$("#fieldsAdd").append("</div>");
	$("#fieldsAdd").append("<div class=\"form-group\" id=\"div21\">");
	$("#div21").append("<label class=\"col-sm-2 control-label\">"+window.i18n.msgStore['frequency']+"</label>");
	$("#div21").append("<select required id=\"frequency\" name=\"frequency\" class=\"col-sm-4\">	<OPTION>"+window.i18n.msgStore['hourly']+"</OPTION><OPTION>"+window.i18n.msgStore['daily']+"</OPTION><OPTION>"+window.i18n.msgStore['weekly']+"</OPTION></select> ");
	$("#fieldsAdd").append("</div>");
	$("#fieldsAdd").append("<div class=\"form-group\" id=\"div3\">");
	$("#div3").append("</div>");
	$("#fieldsAdd").append("</div>");
	$("#fieldsAdd").append("<div class=\"form-group\" id=\"div4\">");
	$("#div4").append("<div class=\"col-sm-2\"></div>");
	$("#div4").append("<input type=\"Submit\" id=\"newAlerts\" name=\"AddAlert\" value=\""+window.i18n.msgStore['confirm']+"\" class=\"btn btn-primary btn-label-left  col-sm-2\"/>");
	$("#fieldsAdd").append("</div>");
	$("#add").append("</fieldset>");
	$("#addBox").append("</form>");
	$("#addAlertsForm").append("</div></div></div></div>");
	 //Stops the submit request
	$("#add").submit(function(e){
        e.preventDefault();
 	});
	 //Redefines the submit request
	 $("#add").submit(function(e){
		 if(data==null){
			 //get the 4 parameters, keyword, subject, core, frequency and serialize them
		 var datastring = $("#add").serialize();	
	 		$.ajax({ 				//Ajax request to the doPost of the Alerts servlet
	       		type: "POST",
	        	url: "./../admin/Alerts",
	       	 	data: datastring,
	        	//if received a response from the server
	        	success: function(data, textStatus, jqXHR) {
	        		getTab();
	        		$("#addAlertsForm").empty();
	        		addAlerts();
	        	},
	        	error: function(jqXHR, textStatus, errorThrown){
	            	 console.log("Something really bad happened " + textStatus);
	              	$("#ajaxResponse").html(jqXHR.responseText);
	        	},
	        	//capture the request before it was sent to server
	        	beforeSend: function(jqXHR, settings){
	            	//disable the button until we get the response
	            	$('#add').attr("disabled", true);
	        	},
	        	//called after the response or error functions are finsihed
	        	complete: function(jqXHR, textStatus){
	            	//enable the button 
	            	$('#add').attr("disabled", false);
	        	}  
	 		});
		 }
	 });
}
function edit(i){
	data = d;
	document.getElementById("keyword").value = d.alerts[i].keyword;
	document.getElementById("subject").value = d.alerts[i].subject;
	document.getElementById("core").value = d.alerts[i].core;
	document.getElementById("frequency").value = d.alerts[i].frequency;
	 //Redefines the submit request
	$("#add").submit(function(e){
        e.preventDefault();
 	});
	//Redefines the submit request
	 $("#add").submit(function(e){
		 if(data!=null){
		 //Gets the Id of the alert and all the parameters of the form and serialize them 
		 var datastring = "_id="+d.alerts[i]._id+"&"+$("#add").serialize();
		 $.ajax({			 	//Ajax request to the doPost of the Alerts servlet
		        type: "POST",
		        url: "./../admin/Alerts",
		        data: datastring,
		        //if received a response from the server
		        success: function(data, textStatus, jqXHR) {
		        	//Clean the responseArea
		        	$("#ajaxResponse").empty();
		        	//Print the alerts with the modifications made 
		        	getTab();
		        	addAlerts();
		        },
		        error: function(jqXHR, textStatus, errorThrown){
		             console.log("Something really bad happened " + textStatus);
		              $("#ajaxResponse").html(jqXHR.responseText);
		        },
		       
		        //capture the request before it was sent to server
		        beforeSend: function(jqXHR, settings){
		            //disable the button until we get the response
		            $('#add').attr("disabled", true);
		        },
		        //called after the response or error functions are finsihed
		        complete: function(jqXHR, textStatus){
		            //enable the button 
		            $('#add').attr("disabled", false);
		            data = null;
		        }  
		 });
		 }
		 });
}
function remove(i){
	// get the id of the alert to remove and serialize it
	var id = "_id="+d.alerts[i]._id;
	$.ajax({		//Ajax request to the doPost of the Alerts servlet
        type: "POST",
        url: "./../admin/Alerts",
        data: id,
        //if received a response from the server
        success: function(textStatus, jqXHR) {
        	//Suppress the row of the tab that was show the now removed alert
        	var row = document.getElementById(i);
            row.parentNode.removeChild(row);
        },
        //If there was no resonse from the server
        error: function(jqXHR, textStatus, errorThrown){
             console.log("Something really bad happened " + textStatus);
              $("#ajaxResponse").html(jqXHR.responseText);
        }
	});
}
</script>
</html>
</body>
</html>